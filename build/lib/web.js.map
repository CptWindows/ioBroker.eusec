{
  "version": 3,
  "sources": ["../../src/lib/web.ts"],
  "sourcesContent": ["import express from \"express\";\r\nimport path from \"path\";\r\nimport fs from \"fs\";\r\nimport mime from \"mime\";\r\nimport * as utils from \"@iobroker/adapter-core\";\r\n\r\n/**\r\n * ProxyEufySecurity class\r\n *\r\n * Reads files from localhost server\r\n *\r\n * @class\r\n * @param {object} server http or https node.js object\r\n * @param {object} webSettings settings of the web server, like <pre><code>{secure: settings.secure, port: settings.port}</code></pre>\r\n * @param {object} adapter web adapter object\r\n * @param {object} instanceSettings instance object with common and native\r\n * @param {object} app express application\r\n * @return {object} object instance\r\n */\r\nclass ProxyEufySecurity {\r\n\r\n    private app: express.Application;\r\n    private config: any;\r\n    private namespace: any;\r\n\r\n    constructor(server: any, webSettings: any, adapter: ioBroker.Adapter, instanceSettings: any, app: express.Application) {\r\n        this.app         = app;\r\n        this.config      = instanceSettings ? instanceSettings.native : {};\r\n        this.namespace   = instanceSettings ? instanceSettings._id.substring(\"system.adapter.\".length) : \"eufy-security\";\r\n        this.config.route = this.config.route || (this.namespace + \"/\");\r\n        this.config.port = parseInt(this.config.port, 10) || 80;\r\n\r\n        // remove leading slash\r\n        if (this.config.route[0] === \"/\") {\r\n            this.config.route = this.config.route.substr(1);\r\n        }\r\n\r\n        const root_path = path.join(utils.getAbsoluteDefaultDataDir(), this.namespace);\r\n        this.app.use(\"/\" + this.config.route, (req: express.Request, res: express.Response) => {\r\n            const fileName = path.join(root_path, req.url.substring(1));\r\n            const normalized_filename = path.resolve(fileName);\r\n\r\n            if (normalized_filename.startsWith(root_path)) {\r\n\r\n                res.setHeader(\"Access-Control-Allow-Origin\", \"*\");\r\n                res.setHeader(\"Access-Control-Allow-Headers\", \"Origin, X-Requested-With, Content-Type, Accept\");\r\n\r\n                if (fs.existsSync(normalized_filename)) {\r\n                    const stat = fs.statSync(normalized_filename);\r\n                    if (!stat.isDirectory()) {\r\n                        let data;\r\n                        try {\r\n                            data = fs.readFileSync(normalized_filename);\r\n                        } catch (e) {\r\n                            res.status(500).send(`[eufy-security] Cannot read file: ${e}`);\r\n                            return;\r\n                        }\r\n                        res.contentType(mime.getType(path.extname(normalized_filename).substring(1)) || \"html\");\r\n                        res.status(200).send(data);\r\n                    }\r\n                } else {\r\n                    res.status(404).send('[eufy-security] File \"' + normalized_filename +'\" not found.');\r\n                }\r\n            } else {\r\n                res.status(403).send('[eufy-security] Access to file \"' + normalized_filename +'\" denied.');\r\n            }\r\n        });\r\n    }\r\n}\r\n\r\nmodule.exports = ProxyEufySecurity;"],
  "mappings": ";;;;;;;;;;;;;;;;;;;AACA,kBAAiB;AACjB,gBAAe;AACf,kBAAiB;AACjB,YAAuB;AAevB,MAAM,kBAAkB;AAAA,EAMpB,YAAY,QAAa,aAAkB,SAA2B,kBAAuB,KAA0B;AACnH,SAAK,MAAc;AACnB,SAAK,SAAc,mBAAmB,iBAAiB,SAAS,CAAC;AACjE,SAAK,YAAc,mBAAmB,iBAAiB,IAAI,UAAU,kBAAkB,MAAM,IAAI;AACjG,SAAK,OAAO,QAAQ,KAAK,OAAO,SAAU,KAAK,YAAY;AAC3D,SAAK,OAAO,OAAO,SAAS,KAAK,OAAO,MAAM,EAAE,KAAK;AAGrD,QAAI,KAAK,OAAO,MAAM,OAAO,KAAK;AAC9B,WAAK,OAAO,QAAQ,KAAK,OAAO,MAAM,OAAO,CAAC;AAAA,IAClD;AAEA,UAAM,YAAY,YAAAA,QAAK,KAAK,MAAM,0BAA0B,GAAG,KAAK,SAAS;AAC7E,SAAK,IAAI,IAAI,MAAM,KAAK,OAAO,OAAO,CAAC,KAAsB,QAA0B;AACnF,YAAM,WAAW,YAAAA,QAAK,KAAK,WAAW,IAAI,IAAI,UAAU,CAAC,CAAC;AAC1D,YAAM,sBAAsB,YAAAA,QAAK,QAAQ,QAAQ;AAEjD,UAAI,oBAAoB,WAAW,SAAS,GAAG;AAE3C,YAAI,UAAU,+BAA+B,GAAG;AAChD,YAAI,UAAU,gCAAgC,gDAAgD;AAE9F,YAAI,UAAAC,QAAG,WAAW,mBAAmB,GAAG;AACpC,gBAAM,OAAO,UAAAA,QAAG,SAAS,mBAAmB;AAC5C,cAAI,CAAC,KAAK,YAAY,GAAG;AACrB,gBAAI;AACJ,gBAAI;AACA,qBAAO,UAAAA,QAAG,aAAa,mBAAmB;AAAA,YAC9C,SAAS,GAAP;AACE,kBAAI,OAAO,GAAG,EAAE,KAAK,qCAAqC,GAAG;AAC7D;AAAA,YACJ;AACA,gBAAI,YAAY,YAAAC,QAAK,QAAQ,YAAAF,QAAK,QAAQ,mBAAmB,EAAE,UAAU,CAAC,CAAC,KAAK,MAAM;AACtF,gBAAI,OAAO,GAAG,EAAE,KAAK,IAAI;AAAA,UAC7B;AAAA,QACJ,OAAO;AACH,cAAI,OAAO,GAAG,EAAE,KAAK,2BAA2B,sBAAqB,cAAc;AAAA,QACvF;AAAA,MACJ,OAAO;AACH,YAAI,OAAO,GAAG,EAAE,KAAK,qCAAqC,sBAAqB,WAAW;AAAA,MAC9F;AAAA,IACJ,CAAC;AAAA,EACL;AACJ;AAEA,OAAO,UAAU;",
  "names": ["path", "fs", "mime"]
}
